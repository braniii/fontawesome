% Copyright 2018--2022 Marcel Krueger
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3c
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Marcel Krueger
%
\RequirePackage{expl3}
\ProvidesExplPackage{fontawesome6}{2022/05/02}{5.15.4}{Font Awesome 6}

\msg_new:nnnn{fontawesome6}{incompatible-version}
  {Incompatible~version~of~Font~Awesome~already~loaded}
  {You~tried~to~load~the~fontawesome6~package~but~there~are~already~some~icons~
    from~Font~Awesome~defined~in~your~document.~This~probably~means~that~a~
    package~for~another~version~of~Font~Awesome~(likely~the~fontawesome~package~
    for~Font~Awesome~5)~is~already~loaded.~Loading~multiple~versions~is~not~
    supported.~Please~remove~all~but~one~version~of~Font~Awesome~from~your~
    document.}
\AddToHook{package/fontawesome/before}{\msg_error:nn {fontawesome6} {incompatible-version}}
\cs_if_free:NF \faHome {\msg_error:nn {fontawesome6} {incompatible-version}}

\RequirePackage{l3keys2e}
\RequirePackage{xparse}

\str_new:N \c__fontawesome_kind_tl
\bool_new:N \l_fontawesome_sharp_bool
\bool_new:N \l_fontawesome_duotone_bool
\str_new:N \l_fontawesome_base_style_str
\str_new:N \l_fontawesome_style_str

\keys_define:nn{fontawesome6}
  {
    pro .code:n = { \str_set:Nn \c__fontawesome_kind_tl { pro } },
    free .code:n = { \str_set:Nn \c__fontawesome_kind_tl { free } },
    fixed .bool_set:N = \c__fontawesome_fixed_bool,
    fixed .default:n = true,
    sharp .bool_set:N = \l_fontawesome_sharp_bool,
    duotone .bool_set:N = \l_fontawesome_duotone_bool,
    solid .code:n = { \str_set:Nn \l_fontawesome_base_style_str { solid } },
    regular .code:n = { \str_set:Nn \l_fontawesome_base_style_str { regular } },
    light .code:n = { \str_set:Nn \l_fontawesome_base_style_str { light } },
    thin .code:n = { \str_set:Nn \l_fontawesome_base_style_str { thin } },
    style .code:n = { \str_set:Nn \l_fontawesome_style_str { #1 } }, % manual override
    style .initial:n = ,
  }
\str_set:Nn \l_fontawesome_base_style_str { solid }
\bool_set_false:N \l_fontawesome_sharp_bool
\bool_set_false:N \l_fontawesome_duotone_bool
\keys_set:nn{fontawesome6}{free}
\ProcessKeysOptions{fontawesome6}

% Compose the style string from a comma-separated list
\cs_new_protected:Npn \fontawesome_compose_style:n #1
  {
    \clist_map_inline:nn {#1}
      {
        \str_case:nnF {\tl_trim_spaces:n {##1}}
          {
            {sharp}   { \bool_set_true:N \l_fontawesome_sharp_bool }
            {duotone} { \bool_set_true:N \l_fontawesome_duotone_bool }
            {solid}   { \str_set:Nn \l_fontawesome_base_style_str { solid } }
            {regular} { \str_set:Nn \l_fontawesome_base_style_str { regular } }
            {light}   { \str_set:Nn \l_fontawesome_base_style_str { light } }
            {thin}    { \str_set:Nn \l_fontawesome_base_style_str { thin } }
          }
          { }
      }
    \tl_set:Nx \l_tmpa_tl
      {
        \bool_if:NTF \l_fontawesome_sharp_bool { sharp- } { }
        \bool_if:NTF \l_fontawesome_duotone_bool { duotone- } { }
        \l_fontawesome_base_style_str
      }
    \str_set:Nx \l_fontawesome_style_str { \l_tmpa_tl }
  }

% User command: set global style (optional)
\NewDocumentCommand\faStyle{m}{
  \fontawesome_compose_style:n {#1}
}

\NewDocumentCommand\faIcon{s o m}{
  \IfNoValueTF{#2}
    { \fontawesome_use_icon:nn{\str_use:N\l_fontawesome_style_str}{#3\IfBooleanT{#1}{-alt}} }
    { \fontawesome_compose_style:n{#2} \fontawesome_use_icon:nn{\str_use:N\l_fontawesome_style_str}{#3\IfBooleanT{#1}{-alt}} }
}

\NewDocumentCommand\faPreselectedIcon{m s o}{
  \IfNoValueTF{#3}
    { \fontawesome_compose_style:n{} \fontawesome_use_icon:nn{\str_use:N\l_fontawesome_style_str}{#1\IfBooleanT{#2}{-alt}} }
    { \fontawesome_compose_style:n{#3} \fontawesome_use_icon:nn{\str_use:N\l_fontawesome_style_str}{#1\IfBooleanT{#2}{-alt}} }
}

\str_case:onTF\c_sys_engine_str{
  {luatex}{}
  {xetex}{}
}{
  \RequirePackage{fontawesome6-utex-helper}
}{
  \RequirePackage{fontawesome6-generic-helper}
}

\msg_new:nnnn{fontawesome6}{icon-not-found}
  {The~requested~icon~#1~was~not~found.}
  {Maybe~you~mistyped~the~icon~name~or~you~are~using~the~wrong~version~of~Font~Awesome~6.~
    Please~check~the~Font~Awesome~Cheatsheet~to~verify~the~spelling~of~#1.~
    If~you~want~to~use~a~Pro~icon,~you~need~to~have~Font~Awesome~6~Pro~installed~and~
    use~XeLaTeX~or~LuaLaTeX.~Then~you~can~activate~Pro~with~the~[pro]~option.~
    If~you~use~XeLaTeX~or~LuaLaTeX,~you~can~also~try~updating~the~Font~Awesome~6~font~files~
    to~make~icons~of~newer~versions~of~Font~Awesome~available.}
\msg_new:nnnn{fontawesome6}{style-substitution}
  {The~requested~icon~#1~has~been~replaced~by~the~solid~version}
  {The~icon~#1~is~not~available~in~the~style~#2.~The~solid~version~will~be~used~instead.~
    To~use~a~#2~style~#1~icon,~you~probably~need~Font~Awesome~6~Pro.~
    To~use~Pro,~you~need~to~have~Font~Awesome~6~Pro~installed~and~
    use~XeLaTeX~or~LuaLaTeX.~Then~you~can~activate~Pro~with~the~[pro]~option.}

% set initial style value
\tl_set:Nx \l_tmpa_tl
{
  \bool_if:NTF \l_fontawesome_sharp_bool { sharp- } { }
  \bool_if:NTF \l_fontawesome_duotone_bool { duotone- } { }
  \l_fontawesome_base_style_str
}
\str_set:Nx \l_fontawesome_style_str { \l_tmpa_tl }